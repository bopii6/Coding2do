# 移动端优化说明

## 已完成的优化

### 1. ✅ 自动登录保持
- **问题**：每次打开应用都需要重新登录
- **解决方案**：
  - 增加了 Supabase session 恢复等待时间（从10秒增加到30秒）
  - 添加了 session 恢复重试机制
  - 使用固定的 storage key 确保 session 持久化
  - 使用 PKCE flow，更适合移动端安全认证

### 2. ✅ PWA 支持
- **创建了 `manifest.json`**：
  - 支持添加到主屏幕
  - 独立窗口显示（standalone）
  - 自定义主题颜色和应用名称

### 3. ✅ 移动端体验优化
- **Viewport 优化**：
  - 添加了 `viewport-fit=cover` 支持全面屏
  - 禁用用户缩放，防止误操作
  - 优化了移动端触摸体验

- **登录体验优化**：
  - 如果有本地数据，允许跳过登录直接使用
  - 登录成功后显示成功提示
  - 改进了错误处理和重试机制

### 4. ✅ 认证逻辑优化
- **智能登录检测**：
  - 检查 localStorage 中是否有保存的 session
  - 如果有 session，等待并重试恢复
  - 如果没有 session 但有本地数据，允许离线使用

## 使用方法

### 添加到主屏幕（iOS）
1. 在 Safari 中打开应用
2. 点击底部的分享按钮
3. 选择"添加到主屏幕"
4. 输入应用名称（可选）
5. 点击"添加"

### 添加到主屏幕（Android）
1. 在 Chrome 中打开应用
2. 点击右上角菜单（三个点）
3. 选择"添加到主屏幕"或"安装应用"
4. 确认添加

## 登录状态保持

登录一次后，应用会：
1. 自动保存 session 到 localStorage
2. 下次打开时自动恢复 session
3. 如果 session 过期，会自动刷新
4. 如果网络问题导致无法恢复，允许使用本地模式

## 注意事项

1. **首次使用**：如果没有账号，需要先注册
2. **离线使用**：即使没有登录，也可以使用本地模式
3. **数据同步**：登录后，数据会自动同步到云端
4. **清除数据**：如果遇到问题，可以清除浏览器缓存重新登录

## 技术细节

### Supabase 配置优化
```javascript
{
  auth: {
    autoRefreshToken: true,      // 自动刷新 token
    persistSession: true,        // 持久化 session
    storageKey: 'sb-auth-token', // 固定 key
    flowType: 'pkce',            // PKCE flow
  }
}
```

### Session 恢复流程
1. 检查 localStorage 中是否有 session
2. 调用 `supabase.auth.getSession()` 恢复 session
3. 如果失败，等待 500ms 后重试
4. 如果仍然失败，允许使用本地模式

## 故障排除

### 问题：每次打开都要登录
**解决方案**：
1. 检查浏览器是否允许 localStorage
2. 清除浏览器缓存后重新登录
3. 确保网络连接正常

### 问题：添加到主屏幕后无法使用
**解决方案**：
1. 确保 manifest.json 文件存在
2. 检查应用是否通过 HTTPS 访问
3. 清除浏览器缓存后重新添加

### 问题：登录后数据丢失
**解决方案**：
1. 检查 Supabase 配置是否正确
2. 查看浏览器控制台是否有错误
3. 数据会自动备份到 localStorage，不会完全丢失




















